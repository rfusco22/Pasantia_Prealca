<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prealca - Panel Sistema</title>
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/static/css/validation.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
      <div class="user-info">
          <img id="user-photo" src="{{ usuario.foto if usuario and usuario.foto else '/static/img/user.png' }}" alt="Foto de {{ usuario.nombre if usuario else 'Usuario' }}" onerror="this.onerror=null;this.src='/static/img/user.png';">
          <h2 id="user-name">{{ usuario.nombre }} {{ usuario.apellido }}</h2>
          <p id="user-role">Sistema</p>
      </div>
      <ul>
          <li><a href="#" data-page="add-user" class="active"><i class="fas fa-user-plus"></i> Agregar Usuario</a></li>
          <li><a href="#" data-page="manage-users"><i class="fas fa-users-cog"></i> Gestionar Usuarios</a></li>
          <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
      </ul>
  </div>

  <!-- Contenido -->
  <div class="content">
      <!-- Mensajes flash -->
      <div id="flash-messages">
          {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                  {% for category, message in messages %}
                      <div class="alert alert-{{ category }}">{{ message }}</div>
                  {% endfor %}
              {% endif %}
          {% endwith %}
      </div>

      <!-- Páginas -->
      <!-- Add User Page -->
      <div id="add-user" class="page active">
          <h2>Agregar Nuevo Usuario</h2>
          <form id="add-user-form" action="/api/admin/users" method="POST" class="form-grid" enctype="multipart/form-data">
            <div class="form-group">
                  <label for="user_foto">Foto:</label>
                  <input type="file" id="user_foto" name="foto" accept="image/png, image/jpeg, image/jpg, image/gif">
                  <div id="user_foto_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_nombre">Nombre:</label>
                  <input type="text" id="user_nombre" name="nombre" placeholder="Nombre del usuario" required>
                  <div id="user_nombre_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_apellido">Apellido:</label>
                  <input type="text" id="user_apellido" name="apellido" placeholder="Apellido del usuario" required>
                  <div id="user_apellido_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_documento_prefix">Documento:</label>
                  <div class="document-input-group">
                      <select id="user_documento_prefix" name="documento_type" required>
                          <option value="V">V</option>
                      </select>
                      <input type="text" id="user_documento_number" name="documento_number" placeholder="Número de documento (ej. 12345678)" required pattern="\d{7,8}">
                  </div>
                  <div id="user_documento_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_correo">Correo:</label>
                  <input type="email" id="user_correo" name="correo" placeholder="Correo electrónico" required>
                  <div id="user_correo_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_contrasena">Contraseña:</label>
                  <input type="password" id="user_contrasena" name="contrasena" placeholder="Contraseña" required autocomplete="new-password" minlength="8">
                  <div id="user_contrasena_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="direccion">Dirección:</label>
                  <input type="text" id="direccion" name="direccion" placeholder="Dirección del usuario" required>
                  <div id="direccion_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="telefono">Teléfono:</label>
                  <input type="tel" id="telefono" name="telefono" placeholder="Número de teléfono (ej. 04121234567)" required pattern="[0-9]{10,11}">
                  <div id="telefono_validation_message" class="field-validation-message"></div>
              </div>
              <div class="form-group">
                  <label for="user_rol">Rol:</label>
                  <select id="user_rol" name="rol" required>
                      <option value="">Seleccione un rol</option>
                      <option value="administrador">Administrador</option>
                      <option value="registro">Registro</option>
                      <option value="control_calidad">Control y Calidad</option>
                      <option value="vendedor">Vendedor</option>
                      <option value="gerencia">Gerencia</option>
                      <option value="sistema">Sistema</option>
                  </select>
              </div>
              <div class="form-group full-width">
                  <button type="submit">Agregar Usuario</button>
              </div>
          </form>
      </div>

      <!-- Manage Users Page -->
      <div id="manage-users" class="page">
          <h2>Gestionar Usuarios</h2>
          <div class="table-container">
              <table id="users-table">
                  <thead>
                      <tr>
                          <th>Nombre</th>
                          <th>Apellido</th>
                          <th>Correo</th>
                          <th>Rol</th>
                          <th>Estado</th>
                          <th>Usuario</th> <!-- NEW: Added for account status -->
                          <th>Última Actividad</th>
                          <th>Acciones</th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- Se llenará con JavaScript -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Modal para editar usuario -->
      <div id="user-form-modal" class="modal">
          <div class="modal-content">
              <span class="close">&times;</span>
              <h3 id="form-title-user">Editar Usuario</h3>
              <form id="user-form" action="/api/admin/users" method="POST" class="form-grid" enctype="multipart/form-data">
                  <input type="hidden" id="user_id_edit" name="id">
                  <div class="form-group">
                      <label for="nombre_user_edit">Nombre:</label>
                      <input type="text" id="nombre_user_edit" name="nombre" placeholder="Ingrese el nombre" required>
                      <div id="nombre_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="apellido_user_edit">Apellido:</label>
                      <input type="text" id="apellido_user_edit" name="apellido" placeholder="Ingrese el apellido" required>
                      <div id="apellido_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="documento_user_edit_prefix">Documento:</label>
                      <div class="document-input-group">
                          <select id="documento_user_edit_prefix" name="documento_type" required>
                              <option value="V">V</option>
                          </select>
                          <input type="text" id="documento_user_edit_number" name="documento_number" placeholder="Número de documento (ej. 12345678)" required pattern="\d{7,8}">
                      </div>
                      <div id="documento_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="correo_user_edit">Correo:</label>
                      <input type="email" id="correo_user_edit" name="correo" placeholder="Ingrese el correo" required>
                      <div id="correo_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="direccion_user_edit">Dirección:</label>
                      <input type="text" id="direccion_user_edit" name="direccion" placeholder="Dirección del usuario" required>
                      <div id="direccion_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="telefono_user_edit">Teléfono:</label>
                      <input type="tel" id="telefono_user_edit" name="telefono" placeholder="Número de teléfono (ej. 04121234567)" required pattern="[0-9]{10,11}">
                      <div id="telefono_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label>Foto Actual:</label>
                      <img id="current_user_photo_preview" src="/static/img/user.png" alt="Foto actual" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-top: 5px;">
                  </div>
                  <div class="form-group">
                      <label for="foto_user_edit">Cambiar Foto:</label>
                      <input type="file" id="foto_user_edit" name="foto" accept="image/png, image/jpeg, image/jpg, image/gif">
                      <div id="foto_user_edit_validation_message" class="field-validation-message"></div>
                  </div>
                  <div class="form-group">
                      <label for="rol_user_edit">Rol:</label>
                      <select id="rol_user_edit" name="rol" required>
                          <option value="administrador">Administrador</option>
                          <option value="registro">Registro</option>
                          <option value="control_calidad">Control y Calidad</option>
                          <option value="vendedor">Vendedor</option>
                          <option value="gerencia">Gerencia</option>
                          <option value="sistema">Sistema</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="status_user_edit">Estado de Cuenta:</label> <!-- NEW: Added for account status -->
                      <select id="status_user_edit" name="status" required>
                          <option value="active">Activo</option>
                          <option value="disabled">Deshabilitado</option>
                      </select>
                  </div>
                  <div class="form-group full-width">
                      <button type="submit">Guardar Cambios</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <script>
      window.userInfo = {
          id: "{{ usuario.id }}",
          nombre: "{{ usuario.nombre }}",
          apellido: "{{ usuario.apellido }}",
          nombreCompleto: "{{ usuario.nombre }} {{ usuario.apellido }}",
          rol: "{{ usuario.rol }}",
          foto: "{{ usuario.foto if usuario and usuario.foto else '/static/img/user.png' }}"
      };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <script src="/static/js/dashboard_sistema.js"></script>
</body>
</html>
